# Day 9 Plan: Data Storage & Persistence

**Date**: December 26, 2025  
**Status**: Ready to Start  
**Estimated Time**: 5 hours  
**Focus**: Store observations in HealthEntry

---

## Current State Analysis

### ✅ What's Already Complete (Day 8)

1. **Mode-Based Rendering**
   - CaptureMenu integrated
   - Mode switching works (menu/voice/bio-mirror/text)
   - Back navigation implemented

2. **Voice Integration**
   - Voice recording works
   - VoiceObservations display after analysis
   - handleTranscript accepts audio blob and analysis
   - Observations stored in temporary state (voiceObservations)

3. **Photo/Bio-Mirror Integration**
   - StateCheckWizard loads in bio-mirror mode
   - Full workflow accessible
   - Back button returns to menu

### ❌ What's Missing (Day 9 Gaps)

1. **Type Definitions**
   - `ParsedResponse` lacks `objectiveObservations` field
   - `ParsedResponse` lacks `gentleInquiry` field
   - `HealthEntry` lacks `objectiveObservations` field

2. **AI Schema**
   - `healthEntrySchema` doesn't include `objectiveObservations`
   - `healthEntrySchema` doesn't include `gentleInquiry`

3. **Data Storage**
   - Observations NOT stored in HealthEntry
   - Voice analysis data lost on submit
   - Photo analysis data lost on submit
   - Text observations not captured

4. **Data Flow**
   - Observations exist in temporary state
   - Not persisted to HealthEntry
   - Not available for future analysis

---

## Day 9 Tasks

### Task 1: Update Type Definitions (1 hour)

#### 1.1 Update ParsedResponse Type
**File**: `src/types.ts`

**Current Issue**:
```typescript
export interface ParsedResponse {
  moodScore: number;
  moodLabel: string;
  medications: { name: string; amount: string; unit: string }[];
  symptoms: { name: string; severity: number }[];
  neuroMetrics: {
    environmentalMentions: string[];
    socialMentions: string[];
    executiveMentions: string[];
    physicalMentions: string[];
  };
  activityTypes: string[];
  strengths: string[];
  summary: string;
  strategies: StrategyRecommendation[];
  analysisReasoning: string;
  // MISSING: objectiveObservations
  // MISSING: gentleInquiry
}
```

**Required Change**:
```typescript
export interface ParsedResponse {
  moodScore: number;
  moodLabel: string;
  medications: { name: string; amount: string; unit: string }[];
  symptoms: { name: string; severity: number }[];
  neuroMetrics: {
    environmentalMentions: string[];
    socialMentions: string[];
    executiveMentions: string[];
    physicalMentions: string[];
  };
  activityTypes: string[];
  strengths: string[];
  summary: string;
  strategies: StrategyRecommendation[];
  analysisReasoning: string;
  
  // ✅ ADD: Objective observations extracted from text
  objectiveObservations?: Observation[];
  
  // ✅ ADD: Gentle inquiry generated by AI
  gentleInquiry?: GentleInquiry;
}
```

**Acceptance Criteria**:
- [ ] Types compile without errors
- [ ] Fields are optional (not required)
- [ ] Reference existing Observation and GentleInquiry types

---

#### 1.2 Update HealthEntry Type
**File**: `src/types.ts`

**Current Issue**:
```typescript
export interface HealthEntry {
  id: string;
  timestamp: string;
  rawText: string;
  mood: number;
  moodLabel: string;
  medications: Medication[];
  symptoms: Symptom[];
  tags: string[];
  activityTypes: string[];
  strengths: string[];
  neuroMetrics: NeuroMetrics;
  sleep?: SleepData;
  notes: string;
  aiStrategies?: StrategyRecommendation[];
  aiReasoning?: string;
  updatedAt?: string;
  // MISSING: objectiveObservations
}
```

**Required Change**:
```typescript
export interface HealthEntry {
  id: string;
  timestamp: string;
  rawText: string;
  mood: number;
  moodLabel: string;
  medications: Medication[];
  symptoms: Symptom[];
  tags: string[];
  activityTypes: string[];
  strengths: string[];
  neuroMetrics: NeuroMetrics;
  sleep?: SleepData;
  notes: string;
  aiStrategies?: StrategyRecommendation[];
  aiReasoning?: string;
  updatedAt?: string;
  
  // ✅ ADD: All objective observations (voice, photo, text)
  objectiveObservations?: ObjectiveObservation[];
}
```

**Acceptance Criteria**:
- [ ] Field is optional (not required)
- [ ] Backward compatible (existing entries still valid)
- [ ] TypeScript compiles without errors

---

### Task 2: Update AI Schema (1.5 hours)

#### 2.1 Update healthEntrySchema
**File**: `src/services/geminiService.ts`

**Current Issue**: Schema doesn't include new fields

**Required Change**:
```typescript
const healthEntrySchema: Schema = {
  type: Type.OBJECT,
  properties: {
    moodScore: { type: Type.NUMBER },
    moodLabel: { type: Type.STRING },
    medications: {
      type: Type.ARRAY,
      items: {
        type: Type.OBJECT,
        properties: {
          name: { type: Type.STRING },
          amount: { type: Type.STRING },
          unit: { type: Type.STRING }
        }
      }
    },
    symptoms: {
      type: Type.ARRAY,
      items: {
        type: Type.OBJECT,
        properties: {
          name: { type: Type.STRING },
          severity: { type: Type.NUMBER }
        }
      }
    },
    neuroMetrics: {
      type: Type.OBJECT,
      properties: {
        environmentalMentions: {
          type: Type.ARRAY,
          items: { type: Type.STRING }
        },
        socialMentions: {
          type: Type.ARRAY,
          items: { type: Type.STRING }
        },
        executiveMentions: {
          type: Type.ARRAY,
          items: { type: Type.STRING }
        },
        physicalMentions: {
          type: Type.ARRAY,
          items: { type: Type.STRING }
        }
      }
    },
    activityTypes: {
      type: Type.ARRAY,
      items: { type: Type.STRING }
    },
    strengths: {
      type: Type.ARRAY,
      items: { type: Type.STRING }
    },
    summary: { type: Type.STRING },
    analysisReasoning: { type: Type.STRING },
    strategies: {
      type: Type.ARRAY,
      items: {
        type: Type.OBJECT,
        properties: {
          id: { type: Type.STRING },
          title: { type: Type.STRING },
          action: { type: Type.STRING },
          type: { 
            type: Type.STRING, 
            enum: ["REST", "FOCUS", "SOCIAL", "SENSORY", "EXECUTIVE"]
          },
          relevanceScore: { type: Type.NUMBER }
        }
      }
    },
    
    // ✅ ADD: Objective observations extracted from text
    objectiveObservations: {
      type: Type.ARRAY,
      items: {
        type: Type.OBJECT,
        properties: {
          category: { 
            type: Type.STRING, 
            enum: ["lighting", "noise", "tension", "fatigue", "speech-pace", "tone"]
          },
          value: { type: Type.STRING },
          severity: { type: Type.STRING, enum: ["low", "moderate", "high"] },
          evidence: { type: Type.STRING }
        },
        required: ["category", "value", "severity", "evidence"]
      },
      description: "Objective data extracted from text (only what user explicitly mentions)"
    },
    
    // ✅ ADD: Gentle inquiry generated by AI
    gentleInquiry: {
      type: Type.OBJECT,
      properties: {
        id: { type: Type.STRING },
        basedOn: { 
          type: Type.ARRAY,
          items: { type: Type.STRING },
          description: "What observations or text the question is based on"
        },
        question: { type: Type.STRING },
        tone: { 
          type: Type.STRING, 
          enum: ["curious", "supportive", "informational"]
        },
        skipAllowed: { type: Type.BOOLEAN },
        priority: { 
          type: Type.STRING, 
          enum: ["low", "medium", "high"]
        }
      },
      required: ["id", "basedOn", "question", "tone", "skipAllowed", "priority"],
      description: "Optional gentle question to ask user (only if high-severity observations)"
    }
  },
  required: [
    "moodScore", "moodLabel", 
    "neuroMetrics", 
    "activityTypes", "strengths", 
    "summary", "strategies", "analysisReasoning"
    // NOTE: objectiveObservations and gentleInquiry are NOT required
  ]
};
```

**Acceptance Criteria**:
- [ ] Schema compiles without errors
- [ ] New fields are optional (not in required array)
- [ ] Field types match type definitions
- [ ] Descriptions are clear
- [ ] Backward compatible (existing parsing still works)

---

### Task 3: Update System Instruction (30 minutes)

#### 3.1 Update AI System Instruction
**File**: `src/services/geminiService.ts`

**Current Status**: System instruction already emphasizes objectivity (from Day 8)

**Additional Enhancement Needed**:
Add guidance for generating objectiveObservations and gentleInquiry:

```typescript
const systemInstruction = `
You are Mae, voice of MAEPLE (Mental And Emotional Pattern Literacy Engine).

CRITICAL PRINCIPLE: OBJECTIVE EXTRACTION, NOT SUBJECTIVE INTERPRETATION

[... existing instruction content ...]

OBJECTIVE OBSERVATIONS GENERATION:

ONLY extract observations if user EXPLICITLY mentions them in text:
- "The fluorescent lights are killing me" → Extract: lighting (high severity)
- "This coffee shop is so loud" → Extract: noise (moderate severity)
- "My eyes feel droopy" → Extract: fatigue (moderate severity)
- "I'm talking really fast right now" → Extract: speech-pace (moderate severity)
- "My voice sounds strained" → Extract: tone (high severity)

DO NOT extract if not explicitly mentioned:
- ❌ "You seem stressed" - NEVER infer stress
- ❌ "You're masking" - NEVER infer masking
- ❌ "Sensory load is high" - NEVER score or assign numerical values

Each observation MUST include:
- category: One of: lighting, noise, tension, fatigue, speech-pace, tone
- value: What user actually said (verbatim or close to it)
- severity: low, moderate, or high (based on user's intensity of language)
- evidence: "mentioned in text"

GENTLE INQUIRY GENERATION:

ONLY generate gentle inquiry if:
- User mentions high-severity observations, AND
- The observation could be affecting their state, AND
- A question would be genuinely helpful

Example of WHEN to generate gentle inquiry:
- User says "fluorescent lights are killing me" → Ask: "How is the lighting affecting you right now?"
- User says "my head is pounding" → Ask: "Would you like strategies for managing the headache?"

Example of WHEN NOT to generate gentle inquiry:
- Low or moderate severity observations → No inquiry needed
- User clearly states their state → No inquiry needed
- Observation is minor or environmental → No inquiry needed

Gentle inquiry format:
- id: unique identifier
- basedOn: Array of observations or text the question relates to
- question: Open-ended, curious question (not yes/no if possible)
- tone: "curious" (never "interrogating" or "demanding")
- skipAllowed: always true
- priority: "high" only if multiple high-severity observations, else "medium"

[... rest of instruction ...]
`;
```

**Acceptance Criteria**:
- [ ] Clear guidance on extracting observations
- [ ] Clear guidance on when to generate gentle inquiries
- [ ] Examples of what to do/not do
- [ ] Maintains objectivity principle

---

### Task 4: Update handleSubmit to Store Observations (1.5 hours)

#### 4.1 Update handleSubmit Function
**File**: `src/components/JournalEntry.tsx`

**Current Issue**: Observations not stored in HealthEntry

**Required Change**:
```typescript
const handleSubmit = async () => {
  if (!text.trim()) return;
  setIsProcessing(true);
  setLastStrategies([]);
  setLastReasoning(null);

  try {
    const parsed: ParsedResponse = await parseJournalEntry(text, capacity);

    // ✅ Build objective observations array
    const objectiveObservations: ObjectiveObservation[] = [];

    // 1. Add voice observations if available
    if (voiceObservations) {
      objectiveObservations.push({
        type: 'audio',
        source: 'voice',
        observations: voiceObservations.observations,
        confidence: voiceObservations.confidence,
        timestamp: new Date().toISOString(),
      });
    }

    // 2. Add photo observations if available
    if (photoObservations) {
      objectiveObservations.push({
        type: 'visual',
        source: 'bio-mirror',
        observations: photoObservations.observations,
        confidence: photoObservations.confidence,
        timestamp: new Date().toISOString(),
      });
    }

    // 3. Add text observations if AI extracted them
    if (parsed.objectiveObservations && parsed.objectiveObservations.length > 0) {
      objectiveObservations.push({
        type: 'text',
        source: 'text-input',
        observations: parsed.objectiveObservations,
        confidence: 0.8, // Text analysis has lower confidence than audio/visual
        timestamp: new Date().toISOString(),
      });
    }

    const newEntry: HealthEntry = {
      id: uuidv4(),
      timestamp: new Date().toISOString(),
      rawText: text,
      mood: parsed.moodScore,
      moodLabel: parsed.moodLabel,
      medications: parsed.medications.map((m) => ({
        name: m.name,
        dosage: m.amount,
        unit: m.unit,
      })),
      symptoms: parsed.symptoms.map((s) => ({
        name: s.name,
        severity: s.severity,
      })),
      tags: [],
      activityTypes: parsed.activityTypes || [],
      strengths: parsed.strengths || [],
      neuroMetrics: {
        spoonLevel: calculateAverageSpoons(),
        sensoryLoad: 0, // Deprecated - using environmentalMentions instead
        contextSwitches: 0, // Calculated from activityTypes later
        maskingScore: 0, // Deprecated - using socialMentions instead
        capacity: capacity,
      },
      notes: parsed.summary,
      aiStrategies: parsed.strategies,
      aiReasoning: parsed.analysisReasoning,
      
      // ✅ Store all objective observations
      objectiveObservations: objectiveObservations.length > 0 
        ? objectiveObservations 
        : undefined,
    };

    // Use AI Generated strategies
    setLastStrategies(parsed.strategies || []);
    setLastReasoning(parsed.analysisReasoning || null);

    onEntryAdded(newEntry);
    setText("");
    
    // Reset to defaults
    setCapacity({
      focus: 7,
      social: 5,
      structure: 4,
      emotional: 6,
      physical: 5,
      sensory: 6,
      executive: 5,
    });
    
    // Reset observation states
    setVoiceObservations(null);
    setPhotoObservations(null);
    
  } catch (e) {
    console.error("Failed to process entry", e);
    alert("Failed to analyze entry. Please try again.");
  } finally {
    setIsProcessing(false);
  }
};
```

**Acceptance Criteria**:
- [ ] Voice observations stored if available
- [ ] Photo observations stored if available
- [ ] Text observations stored if parsed
- [ ] All observation types included in array
- [ ] Observation states reset after submission
- [ ] Only store if observations exist (undefined if empty)
- [ ] Types match ObjectiveObservation interface

---

### Task 5: Verify Data Persistence (30 minutes)

#### 5.1 Test Observation Storage

**Test Cases**:
1. **Text-only entry**
   - Type entry without voice or photo
   - Submit
   - Check HealthEntry has objectiveObservations (from text analysis)
   - Verify localStorage stores data

2. **Voice entry**
   - Record voice note
   - See observations
   - Submit entry
   - Check HealthEntry has voice observations
   - Verify type: 'audio', source: 'voice'

3. **Photo entry**
   - Use bio-mirror
   - Capture photo
   - Submit entry
   - Check HealthEntry has photo observations
   - Verify type: 'visual', source: 'bio-mirror'

4. **Mixed entry**
   - Record voice note
   - Type additional text
   - Submit entry
   - Check HealthEntry has both audio and text observations

**Verification**:
```typescript
// In browser console or test
const entries = storageService.getEntries();
const latest = entries[entries.length - 1];
console.log('Latest entry:', latest);
console.log('Objective observations:', latest.objectiveObservations);
// Should show array of observations with type, source, observations, confidence, timestamp
```

**Acceptance Criteria**:
- [ ] All test cases pass
- [ ] Observations persist in localStorage
- [ ] Data structure matches interface
- [ ] No data loss on page refresh
- [ ] Empty observations stored as undefined (not empty array)

---

## Success Criteria

### Must-Have
- [ ] ParsedResponse type includes objectiveObservations and gentleInquiry
- [ ] HealthEntry type includes objectiveObservations
- [ ] AI schema includes new fields
- [ ] System instruction updated
- [ ] handleSubmit stores observations
- [ ] Observations persist in localStorage
- [ ] TypeScript compiles without errors

### Nice-to-Have
- [ ] Test coverage for new functionality
- [ ] Migration script for existing entries (if needed)
- [ ] Debug logging for observation storage
- [ ] Validation that observations aren't corrupted

---

## Risk Mitigation

### Risk 1: Breaking Existing Data

**Issue**: Adding fields to HealthEntry might break existing entries

**Mitigation**:
- Fields are optional (not required)
- Backward compatible
- Old entries will have undefined for new fields
- Default to undefined, not empty array

### Risk 2: AI Not Returning New Fields

**Issue**: AI might not populate new fields

**Mitigation**:
- Fields are optional in schema
- Code handles undefined gracefully
- Fallback to no observations if missing
- Default response includes empty arrays

### Risk 3: Type Mismatches

**Issue**: Observation types might not match between services

**Mitigation**:
- Use centralized Observation type from types.ts
- All services reference same type
- Validate before storage
- TypeScript catches mismatches at compile time

---

## Order of Operations

1. **Step 1**: Update ParsedResponse type (15 minutes)
2. **Step 2**: Update HealthEntry type (15 minutes)
3. **Step 3**: Update AI schema (1 hour)
4. **Step 4**: Update system instruction (30 minutes)
5. **Step 5**: Update handleSubmit (1.5 hours)
6. **Step 6**: Test all scenarios (1 hour)

**Total**: 5 hours

---

## Next Steps After Day 9

Day 10 will focus on **Informed Capacity Calibration**:
- Use observations to suggest capacity values
- Display context for each suggestion
- Show which sliders are informed by observations
- Allow user to override suggestions

---

## Conclusion

Day 9 focuses on ensuring observations are properly stored and persisted. This is critical for future analysis and pattern recognition.

**Key Success Factor**: Verify data is actually persisting and can be retrieved later.

**Ready to Start**: Yes, all prerequisites complete from Day 8.
